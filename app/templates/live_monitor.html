{% extends 'base.html' %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <div class="row align-items-center">
            <div class="col-md-6">
              <h4 class="mb-0"><i class="bi bi-broadcast"></i> Real-Time Options Monitor</h4>
              <small>Per-user isolated monitoring with live updates</small>
            </div>
            <div class="col-md-6 text-end">
              <div class="btn-group" role="group">
                <button class="btn btn-success" onclick="startMonitoring()" id="startBtn">
                  <i class="bi bi-play-fill"></i> Start
                </button>
                <button class="btn btn-danger" onclick="stopMonitoring()" id="stopBtn" disabled>
                  <i class="bi bi-stop-fill"></i> Stop
                </button>
                <button class="btn btn-info" onclick="showSettings()">
                  <i class="bi bi-gear"></i> Settings
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <div class="card-body">
          <!-- Control Panel -->
          <div class="row mb-4">
            <div class="col-md-3">
              <label class="form-label">Symbols (comma-separated)</label>
              <input type="text" class="form-control" id="symbolsInput" 
                     placeholder="RELIANCE, TCS, INFY" value="">
              <small class="text-muted">Or click below to load predefined list</small>
              <div class="mt-2">
                <button class="btn btn-sm btn-outline-primary" onclick="loadPredefinedSymbols()">
                  Load 200+ Symbols
                </button>
              </div>
            </div>
            <div class="col-md-2">
              <label class="form-label">Distance %</label>
              <select class="form-select" id="distancePercentage">
                <option value="5">5%</option>
                <option value="10" selected>10%</option>
                <option value="15">15%</option>
                <option value="20">20%</option>
                <option value="25">25%</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Expiry Date</label>
              <select class="form-select" id="expirySelect">
                <option value="">Loading...</option>
              </select>
            </div>
            <div class="col-md-2">
              <label class="form-label">Refresh (seconds)</label>
              <select class="form-select" id="refreshInterval">
                <option value="5">5 sec</option>
                <option value="10" selected>10 sec</option>
                <option value="30">30 sec</option>
                <option value="60">60 sec</option>
              </select>
            </div>
            <div class="col-md-2">
              <label class="form-label">Update Mode</label>
              <div class="form-check form-switch mt-2">
                <input class="form-check-input" type="checkbox" id="diffMode" checked>
                <label class="form-check-label" for="diffMode">
                  Diff Updates
                </label>
              </div>
            </div>
          </div>

          <!-- Status Bar -->
          <div class="alert alert-info" role="alert" id="statusBar">
            <div class="row">
              <div class="col-md-2">
                <strong>Status:</strong> <span id="monitorStatus" class="text-danger">Stopped</span>
              </div>
              <div class="col-md-2">
                <strong>Symbols:</strong> <span id="symbolCount">0</span>
              </div>
              <div class="col-md-2">
                <strong>Last Update:</strong> <span id="lastUpdate">Never</span>
              </div>
              <div class="col-md-2">
                <strong>Filtered:</strong> <span id="filteredCount">0</span>
              </div>
              <div class="col-md-2">
                <strong>High Yield:</strong> <span id="highYieldCount">0</span>
              </div>
              <div class="col-md-2">
                <strong>Fetch Time:</strong> <span id="fetchTime">-</span>
              </div>
            </div>
          </div>

          <!-- Live Data Display -->
          <div id="liveDataContainer">
            <div class="text-center py-5" id="emptyState">
              <i class="bi bi-broadcast display-1 text-muted"></i>
              <h3 class="mt-3 text-muted">Real-Time Monitor</h3>
              <p class="text-muted">Configure settings above and click "Start" to begin live monitoring</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div class="modal fade" id="settingsModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Monitor Settings</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Display Options</label>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="showFiltered" checked>
            <label class="form-check-label" for="showFiltered">
              Show Filtered Table (Yield > 50k, Dist% > 15%)
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="showHighYield" checked>
            <label class="form-check-label" for="showHighYield">
              Show High Yield Table (Yield > 80k)
            </label>
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label">Notification Options</label>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="soundNotifications">
            <label class="form-check-label" for="soundNotifications">
              Sound alerts for new contracts
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="highlightChanges" checked>
            <label class="form-check-label" for="highlightChanges">
              Highlight updated rows
            </label>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" onclick="applySettings()" data-bs-dismiss="modal">Apply</button>
      </div>
    </div>
  </div>
</div>

<script>
// Predefined symbols list (200+ liquid F&O stocks)
const PREDEFINED_SYMBOLS = [
  "ADANIENSOL", "ADANIENT", "ADANIGREEN", "ADANIPORTS", "AMBUJACEM", "ASHOKLEY",
  "ASIANPAINT", "ASTRAL", "AXISBANK", "BAJAJ-AUTO", "BAJAJFINSV", "BAJFINANCE",
  "BANKBARODA", "BDL", "BEL", "BHARATFORG", "BHARTIARTL", "BHEL", "BPCL", "BRITANNIA",
  "BSE", "CAMS", "CANBK", "CDSL", "CGPOWER", "CHOLAFIN", "CIPLA", "COALINDIA",
  "COFORGE", "COLPAL", "CROMPTON", "CUMMINSIND", "DABUR", "DALBHARAT", "DELHIVERY",
  "DIVISLAB", "DIXON", "DLF", "DMART", "EICHERMOT", "ETERNAL", "EXIDEIND", "GAIL",
  "GLENMARK", "GMRAIRPORT", "GODREJCP", "GODREJPROP", "HAL", "HAVELLS", "HCLTECH",
  "HDFCBANK", "HDFCLIFE", "HEROMOTOCO", "HFCL", "HINDALCO", "HINDPETRO", "HINDUNILVR",
  "HINDZINC", "HUDCO", "ICICIBANK", "ICICIPRULI", "IDFCFIRSTB", "IEX", "IGL", "INDHOTEL",
  "INDIANB", "INDIGO", "INDUSINDBK", "INDUSTOWER", "INFY", "IOC", "IRCTC", "IREDA", "IRFC",
  "ITC", "JINDALSTEL", "JIOFIN", "JSWSTEEL", "KALYANKJIL", "KAYNES", "KFINTECH", "KOTAKBANK",
  "LAURUSLABS", "LICI", "LT", "LTF", "M&M", "MANAPPURAM", "MARUTI", "MAZDOCK", "MCX",
  "MOTHERSON", "MPHASIS", "MUTHOOTFIN", "NATIONALUM", "NCC", "NESTLEIND", "NHPC",
  "NTPC", "NYKAA", "ONGC", "PAYTM", "PERSISTENT", "PETRONET", "PFC", "PGEL", "PNB",
  "PNBHOUSING", "POLICYBZR", "POLYCAB", "POWERGRID", "PPLPHARMA", "PRESTIGE", "RBLBANK",
  "RECLTD", "RELIANCE", "RVNL", "SAIL", "SBICARD", "SBILIFE", "SBIN", "SHREECEM",
  "SHRIRAMFIN", "SIEMENS", "SOLARINDS", "SONACOMS", "SUNPHARMA", "SUPREMEIND", "SUZLON",
  "TATACONSUM", "TATAELXSI", "TATAMOTORS", "TATAPOWER", "TATASTEEL", "TCS", "TECHM", "TIINDIA",
  "TITAGARH", "TITAN", "TORNTPHARM", "TORNTPOWER", "TRENT", "TVSMOTOR", "ULTRACEMCO",
  "UNIONBANK", "UNITDSPR", "UNOMINDA", "UPL", "VBL", "VEDL", "VOLTAS", "WIPRO",
  "YESBANK", "ZYDUSLIFE"
];

let isMonitoring = false;
let updateInterval = null;
let useDiffMode = true;

// Settings
let showFiltered = true;
let showHighYield = true;
let highlightChanges = true;
let soundNotifications = false;

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
  loadExpiryDates();
});

function loadExpiryDates() {
  fetch("{{ url_for('main.api_live_monitor_expiry_dates') }}")
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        const expirySelect = document.getElementById('expirySelect');
        expirySelect.innerHTML = '<option value="">Select Expiry</option>';
        
        data.expiry_dates.forEach(date => {
          const option = document.createElement('option');
          option.value = date;
          option.textContent = date;
          expirySelect.appendChild(option);
        });
        
        // Set default to first date
        if (data.expiry_dates.length > 0) {
          expirySelect.value = data.expiry_dates[0];
        }
      }
    })
    .catch(error => {
      console.error('Error loading expiry dates:', error);
    });
}

function loadPredefinedSymbols() {
  document.getElementById('symbolsInput').value = PREDEFINED_SYMBOLS.join(', ');
  alert(`Loaded ${PREDEFINED_SYMBOLS.length} predefined symbols`);
}

function startMonitoring() {
  const symbolsInput = document.getElementById('symbolsInput').value;
  const symbols = symbolsInput.split(',').map(s => s.trim().toUpperCase()).filter(s => s);
  const expiry = document.getElementById('expirySelect').value;
  const distance = parseInt(document.getElementById('distancePercentage').value);
  const refresh = parseInt(document.getElementById('refreshInterval').value);
  
  // Validation
  if (symbols.length === 0) {
    alert('Please enter symbols');
    return;
  }
  
  if (!expiry) {
    alert('Please select an expiry date');
    return;
  }
  
  // Update settings
  useDiffMode = document.getElementById('diffMode').checked;
  
  // Start monitoring session on server
  fetch("{{ url_for('main.api_live_monitor_start') }}", {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      symbols: symbols,
      expiry_date: expiry,
      distance_percentage: distance,
      refresh_interval: refresh
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.status === 'started') {
      isMonitoring = true;
      
      // Update UI
      document.getElementById('startBtn').disabled = true;
      document.getElementById('stopBtn').disabled = false;
      document.getElementById('monitorStatus').textContent = 'Running';
      document.getElementById('monitorStatus').className = 'text-success';
      document.getElementById('symbolCount').textContent = symbols.length;
      document.getElementById('emptyState').style.display = 'none';
      
      // Start update loop
      startUpdateLoop();
      
      console.log('Monitoring started:', data);
    } else {
      alert('Failed to start monitoring: ' + (data.error || 'Unknown error'));
    }
  })
  .catch(error => {
    console.error('Error starting monitoring:', error);
    alert('Error: ' + error.message);
  });
}

function stopMonitoring() {
  fetch("{{ url_for('main.api_live_monitor_stop') }}", {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' }
  })
  .then(response => response.json())
  .then(data => {
    isMonitoring = false;
    
    // Stop update loop
    if (updateInterval) {
      clearInterval(updateInterval);
      updateInterval = null;
    }
    
    // Update UI
    document.getElementById('startBtn').disabled = false;
    document.getElementById('stopBtn').disabled = true;
    document.getElementById('monitorStatus').textContent = 'Stopped';
    document.getElementById('monitorStatus').className = 'text-danger';
    
    console.log('Monitoring stopped');
  })
  .catch(error => {
    console.error('Error stopping monitoring:', error);
  });
}

function startUpdateLoop() {
  // Initial fetch
  fetchData();
  
  // Set up periodic updates
  const refreshRate = parseInt(document.getElementById('refreshInterval').value) * 1000;
  updateInterval = setInterval(fetchData, refreshRate);
}

function fetchData() {
  if (!isMonitoring) {
    return;
  }
  
  const endpoint = useDiffMode ? 
    "{{ url_for('main.api_live_monitor_changes') }}" : 
    "{{ url_for('main.api_live_monitor_data') }}";
  
  fetch(endpoint)
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        if (useDiffMode && data.has_changes) {
          applyDiffs(data.changes);
        } else if (!useDiffMode) {
          displayFullData(data.data);
        }
        
        // Update status bar
        updateStatusBar(data);
      }
    })
    .catch(error => {
      console.error('Error fetching data:', error);
    });
}

function displayFullData(data) {
  const container = document.getElementById('liveDataContainer');
  container.innerHTML = '';
  
  const filteredData = data.filtered_data;
  
  if (!filteredData || (!filteredData.filtered && !filteredData.high_yield)) {
    container.innerHTML = '<div class="alert alert-warning">No filtered data available yet</div>';
    return;
  }
  
  // Display Filtered Table
  if (showFiltered && filteredData.filtered && filteredData.filtered.length > 0) {
    container.appendChild(createTable('Filtered Contracts', filteredData.filtered, 'filtered'));
  }
  
  // Display High Yield Table
  if (showHighYield && filteredData.high_yield && filteredData.high_yield.length > 0) {
    container.appendChild(createTable('High Yield Contracts', filteredData.high_yield, 'high_yield'));
  }
  
  // Update counts
  document.getElementById('filteredCount').textContent = filteredData.filtered ? filteredData.filtered.length : 0;
  document.getElementById('highYieldCount').textContent = filteredData.high_yield ? filteredData.high_yield.length : 0;
}

// Add this function
function showDebugInfo() {
  fetch("{{ url_for('main.api_live_monitor_debug') }}")
    .then(response => response.json())
    .then(data => {
      console.log('=== LIVE MONITOR DEBUG INFO ===');
      console.log(data);
      
      if (data.status === 'success') {
        const debug = data.debug;
        alert(`Debug Info:
Is Running: ${debug.is_running}
Worker Thread Alive: ${debug.worker_thread_alive}
Symbols: ${debug.symbols.join(', ')}
Last Update: ${debug.last_update || 'Never'}
Fetch Count: ${debug.stats.fetch_count}
Error Count: ${debug.stats.error_count}
Last Error: ${debug.stats.last_error || 'None'}
Filtered Count: ${debug.filtered_data.filtered_count}
High Yield Count: ${debug.filtered_data.high_yield_count}
Queue Size: ${debug.changes_queue_size}

Check browser console for full details.`);
      } else {
        alert('Debug Error: ' + data.error);
        console.error(data);
      }
    })
    .catch(error => {
      console.error('Debug fetch error:', error);
      alert('Failed to fetch debug info: ' + error.message);
    });
}

// Add debug button to the UI (add this to your HTML)
// Or just call showDebugInfo() from browser console

function createTable(title, rows, type) {
  const card = document.createElement('div');
  card.className = 'card mb-3';
  card.id = `table-${type}`;
  
  const bgClass = type === 'filtered' ? 'bg-warning' : 'bg-success';
  
  card.innerHTML = `
    <div class="card-header ${bgClass} text-white">
      <h5 class="mb-0"><i class="bi bi-table"></i> ${title} <span class="badge bg-light text-dark">${rows.length}</span></h5>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-striped table-hover mb-0">
          <thead class="table-dark">
            <tr>
              <th>Symbol</th>
              <th>CMP</th>
              <th>Type</th>
              <th>Strike</th>
              <th>Bid</th>
              <th>Days Left</th>
              <th>Prem/Day</th>
              <th>Prem Until Expiry</th>
              <th>Yield</th>
              <th>Dist %</th>
            </tr>
          </thead>
          <tbody id="tbody-${type}">
            ${rows.map(row => createTableRow(row, type)).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;
  
  return card;
}

function createTableRow(row, type) {
  const optionTypeClass = row.OptionType === 'CE' ? 'success' : 'danger';
  
  // Conditional coloring based on type
  let rowClass = '';
  if (highlightChanges) {
    if (type === 'filtered') {
      const dist = parseFloat(row['Dist %']) || 0;
      if (dist >= 15 && dist < 18) rowClass = 'table-warning';
      else if (dist >= 18 && dist < 20) rowClass = 'table-success';
      else if (dist >= 20) rowClass = 'table-info';
    } else if (type === 'high_yield') {
      const yield_val = parseFloat(row.Yield) || 0;
      if (yield_val >= 80000 && yield_val < 100000) rowClass = 'table-warning';
      else if (yield_val >= 100000 && yield_val < 150000) rowClass = 'table-success';
      else if (yield_val >= 150000) rowClass = 'table-info';
    }
  }
  
  return `
    <tr class="${rowClass}" data-key="${row.Symbol}_${row.OptionType}_${row.StrikePrice}">
      <td><strong>${row.Symbol || ''}</strong></td>
      <td>₹${formatNumber(row.CMP)}</td>
      <td><span class="badge bg-${optionTypeClass}">${row.OptionType || ''}</span></td>
      <td>₹${formatNumber(row.StrikePrice)}</td>
      <td>₹${formatNumber(row.BidPrice)}</td>
      <td>${row['Days Left'] || 0}</td>
      <td>₹${formatNumber(row['Prem/Day'])}</td>
      <td>₹${formatNumber(row['Prem Until Expiry'])}</td>
      <td class="fw-bold">₹${formatNumber(row.Yield)}</td>
      <td>${formatNumber(row['Dist %'])}%</td>
    </tr>
  `;
}

function applyDiffs(changes) {
  // Apply incremental changes to existing tables
  console.log('Applying diffs:', changes);
  
  // Handle filtered table changes
  if (changes.filtered_added && changes.filtered_added.length > 0) {
    addRows('filtered', changes.filtered_added);
    if (soundNotifications) playNotificationSound();
  }
  
  if (changes.filtered_updated && changes.filtered_updated.length > 0) {
    updateRows('filtered', changes.filtered_updated);
  }
  
  if (changes.filtered_removed && changes.filtered_removed.length > 0) {
    removeRows('filtered', changes.filtered_removed);
  }
  
  // Handle high_yield table changes
  if (changes.high_yield_added && changes.high_yield_added.length > 0) {
    addRows('high_yield', changes.high_yield_added);
    if (soundNotifications) playNotificationSound();
  }
  
  if (changes.high_yield_updated && changes.high_yield_updated.length > 0) {
    updateRows('high_yield', changes.high_yield_updated);
  }
  
  if (changes.high_yield_removed && changes.high_yield_removed.length > 0) {
    removeRows('high_yield', changes.high_yield_removed);
  }
}

function addRows(type, rows) {
  const tbody = document.getElementById(`tbody-${type}`);
  if (!tbody) return;
  
  rows.forEach(row => {
    const rowHtml = createTableRow(row, type);
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = rowHtml;
    const newRow = tempDiv.firstElementChild;
    
    // Add with animation
    newRow.style.backgroundColor = '#ffeb3b';
    tbody.insertBefore(newRow, tbody.firstChild);
    
    setTimeout(() => {
      newRow.style.backgroundColor = '';
    }, 2000);
  });
}

function updateRows(type, rows) {
  const tbody = document.getElementById(`tbody-${type}`);
  if (!tbody) return;
  
  rows.forEach(row => {
    const key = `${row.Symbol}_${row.OptionType}_${row.StrikePrice}`;
    const existingRow = tbody.querySelector(`tr[data-key="${key}"]`);
    
    if (existingRow) {
      // Update with animation
      existingRow.style.backgroundColor = '#4caf50';
      
      const newRowHtml = createTableRow(row, type);
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = newRowHtml;
      const newRow = tempDiv.firstElementChild;
      
      existingRow.replaceWith(newRow);
      
      setTimeout(() => {
        newRow.style.backgroundColor = '';
      }, 2000);
    }
  });
}

function removeRows(type, rows) {
  const tbody = document.getElementById(`tbody-${type}`);
  if (!tbody) return;
  
  rows.forEach(row => {
    const key = `${row.Symbol}_${row.OptionType}_${row.StrikePrice}`;
    const existingRow = tbody.querySelector(`tr[data-key="${key}"]`);
    
    if (existingRow) {
      existingRow.style.backgroundColor = '#f44336';
      setTimeout(() => {
        existingRow.remove();
      }, 1000);
    }
  });
}

function updateStatusBar(data) {
  document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
  
  if (data.data && data.data.stats) {
    const stats = data.data.stats;
    document.getElementById('fetchTime').textContent = `${stats.last_fetch_time ? stats.last_fetch_time.toFixed(2) : '-'}s`;
  }
}

function formatNumber(value) {
  if (value === null || value === undefined) return '0.00';
  return parseFloat(value).toFixed(2);
}

function playNotificationSound() {
  // Simple beep sound
  const audioContext = new (window.AudioContext || window.webkitAudioContext)();
  const oscillator = audioContext.createOscillator();
  const gainNode = audioContext.createGain();
  
  oscillator.connect(gainNode);
  gainNode.connect(audioContext.destination);
  
  oscillator.frequency.value = 800;
  oscillator.type = 'sine';
  
  gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
  gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
  
  oscillator.start(audioContext.currentTime);
  oscillator.stop(audioContext.currentTime + 0.5);
}

function showSettings() {
  const modal = new bootstrap.Modal(document.getElementById('settingsModal'));
  modal.show();
}

function applySettings() {
  showFiltered = document.getElementById('showFiltered').checked;
  showHighYield = document.getElementById('showHighYield').checked;
  highlightChanges = document.getElementById('highlightChanges').checked;
  soundNotifications = document.getElementById('soundNotifications').checked;
  
  // Re-render if monitoring
  if (isMonitoring) {
    fetchData();
  }
}

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
  if (isMonitoring) {
    stopMonitoring();
  }
});
</script>

<style>
.table-responsive {
  max-height: 600px;
  overflow-y: auto;
}

.table thead {
  position: sticky;
  top: 0;
  z-index: 10;
}

tr {
  transition: background-color 0.3s ease;
}
</style>

{% endblock %}