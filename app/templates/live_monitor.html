{% extends 'base.html' %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <div class="row align-items-center">
            <div class="col-md-6">
              <h4 class="mb-0"><i class="bi bi-broadcast"></i> Real-Time Options Monitor (SIMPLIFIED)</h4>
              <small>Per-user isolated monitoring with reliable updates - Simplified version</small>
            </div>
            <div class="col-md-6 text-end">
              <div class="btn-group" role="group">
                <button class="btn btn-success" onclick="startMonitoring()" id="startBtn">
                  <i class="bi bi-play-fill"></i> Start
                </button>
                <button class="btn btn-danger" onclick="stopMonitoring()" id="stopBtn" disabled>
                  <i class="bi bi-stop-fill"></i> Stop
                </button>
                <button class="btn btn-info" onclick="showSettings()">
                  <i class="bi bi-gear"></i> Settings
                </button>
                <button class="btn btn-warning btn-sm" onclick="refreshData()">
                  <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <div class="card-body">
          <!-- Control Panel -->
          <div class="row mb-4">
            <div class="col-md-3">
              <label class="form-label">Symbols (comma-separated)</label>
              <input type="text" class="form-control" id="symbolsInput" 
                     placeholder="RELIANCE, TCS, INFY" value="">
              <small class="text-muted">Or click below to load predefined list</small>
              <div class="mt-2">
                <button class="btn btn-sm btn-outline-primary" onclick="loadPredefinedSymbols()">
                  Load 200+ Symbols
                </button>
              </div>
            </div>
            <div class="col-md-2">
              <label class="form-label">Distance %</label>
              <select class="form-select" id="distancePercentage">
                <option value="5">5%</option>
                <option value="10">10%</option>
                <option value="15">15%</option>
                <option value="20" selected>20%</option>
                <option value="25">25%</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Expiry Date</label>
              <select class="form-select" id="expirySelect">
                <option value="">Loading...</option>
              </select>
            </div>
            <div class="col-md-2">
              <label class="form-label">Refresh (seconds)</label>
              <select class="form-select" id="refreshInterval">
                <option value="15">15 sec</option>
                <option value="30">30 sec</option>
                <option value="60" selected>60 sec</option>
                <option value="120">120 sec</option>
              </select>
            </div>
            <div class="col-md-2">
              <label class="form-label">Update Mode</label>
              <div class="form-check form-switch mt-2">
                <input class="form-check-input" type="checkbox" id="diffMode">
                <label class="form-check-label" for="diffMode">
                  Full Refresh Only
                </label>
              </div>
              <small class="text-muted">Simplified mode</small>
            </div>
          </div>

          <!-- Status Bar -->
          <div class="alert alert-info" role="alert" id="statusBar">
            <div class="row">
              <div class="col-md-2">
                <strong>Status:</strong> <span id="monitorStatus" class="text-danger">Stopped</span>
              </div>
              <div class="col-md-2">
                <strong>Symbols:</strong> <span id="symbolCount">0</span>
              </div>
              <div class="col-md-2">
                <strong>Last Update:</strong> <span id="lastUpdate">Never</span>
              </div>
              <div class="col-md-2">
                <strong>Filtered:</strong> <span id="filteredCount">0</span>
              </div>
              <div class="col-md-2">
                <strong>High Yield:</strong> <span id="highYieldCount">0</span>
              </div>
              <div class="col-md-2">
                <strong>Fetch Time:</strong> <span id="fetchTime">-</span>
              </div>
            </div>
          </div>

          <!-- Live Data Display -->
          <div id="liveDataContainer">
            <div class="text-center py-5" id="emptyState">
              <i class="bi bi-broadcast display-1 text-muted"></i>
              <h3 class="mt-3 text-muted">Real-Time Monitor (SIMPLIFIED)</h3>
              <p class="text-muted">Configure settings above and click "Start" to begin live monitoring</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div class="modal fade" id="settingsModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Monitor Settings</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Display Options</label>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="showFiltered" checked>
            <label class="form-check-label" for="showFiltered">
              Show Filtered Table (Yield > 50k, Dist% > 15%)
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="showHighYield" checked>
            <label class="form-check-label" for="showHighYield">
              Show High Yield Table (Yield > 80k)
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="highlightChanges" checked>
            <label class="form-check-label" for="highlightChanges">
              Highlight Row Changes
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="soundNotifications" checked>
            <label class="form-check-label" for="soundNotifications">
              Sound Notifications
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="autoRefresh" checked>
            <label class="form-check-label" for="autoRefresh">
              Auto-refresh when data available
            </label>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" onclick="applySettings()" data-bs-dismiss="modal">Apply</button>
      </div>
    </div>
  </div>
</div>

<script>
const PREDEFINED_SYMBOLS = [
  "ADANIENSOL", "ADANIENT", "ADANIGREEN", "ADANIPORTS", "AMBUJACEM", "ASHOKLEY",
  "ASIANPAINT", "ASTRAL", "AXISBANK", "BAJAJ-AUTO", "BAJAJFINSV", "BAJFINANCE",
  "BANKBARODA", "BDL", "BEL", "BHARATFORG", "BHARTIARTL", "BHEL", "BPCL", "BRITANNIA",
  "BSE", "CAMS", "CANBK", "CDSL", "CGPOWER", "CHOLAFIN", "CIPLA", "COALINDIA",
  "COFORGE", "COLPAL", "CROMPTON", "CUMMINSIND", "DABUR", "DALBHARAT", "DELHIVERY",
  "DIVISLAB", "DIXON", "DLF", "DMART", "EICHERMOT", "ETERNAL", "EXIDEIND", "GAIL",
  "GLENMARK", "GMRAIRPORT", "GODREJCP", "GODREJPROP", "HAL", "HAVELLS", "HCLTECH",
  "HDFCBANK", "HDFCLIFE", "HEROMOTOCO", "HFCL", "HINDALCO", "HINDPETRO", "HINDUNILVR",
  "HINDZINC", "HUDCO", "ICICIBANK", "ICICIPRULI", "IDFCFIRSTB", "IEX", "IGL", "INDHOTEL",
  "INDIANB", "INDIGO", "INDUSINDBK", "INDUSTOWER", "INFY", "IOC", "IRCTC", "IREDA", "IRFC",
  "ITC", "JINDALSTEL", "JIOFIN", "JSWSTEEL", "KALYANKJIL", "KAYNES", "KFINTECH", "KOTAKBANK",
  "LAURUSLABS", "LICI", "LT", "LTF", "M&M", "MANAPPURAM", "MARUTI", "MAZDOCK", "MCX",
  "MOTHERSON", "MPHASIS", "MUTHOOTFIN", "NATIONALUM", "NCC", "NESTLEIND", "NHPC",
  "NTPC", "NYKAA", "ONGC", "PAYTM", "PERSISTENT", "PETRONET", "PFC", "PGEL", "PNB",
  "PNBHOUSING", "POLICYBZR", "POLYCAB", "POWERGRID", "PPLPHARMA", "PRESTIGE", "RBLBANK",
  "RECLTD", "RELIANCE", "RVNL", "SAIL", "SBICARD", "SBILIFE", "SBIN", "SHREECEM",
  "SHRIRAMFIN", "SIEMENS", "SOLARINDS", "SONACOMS", "SUNPHARMA", "SUPREMEIND", "SUZLON",
  "TATACONSUM", "TATAELXSI", "TMPV", "TATAPOWER", "TATASTEEL", "TCS", "TECHM", "TIINDIA",
  "TITAGARH", "TITAN", "TORNTPHARM", "TORNTPOWER", "TRENT", "TVSMOTOR", "ULTRACEMCO",
  "UNIONBANK", "UNITDSPR", "UNOMINDA", "UPL", "VBL", "VEDL", "VOLTAS", "WIPRO",
  "YESBANK", "ZYDUSLIFE"
];

// SIMPLIFIED: Clean state management
let isMonitoring = false;
let updateInterval = null;
let initialLoadInterval = null;
let showFiltered = true;
let showHighYield = true;
let highlightChanges = true;
let soundNotifications = true;
let autoRefresh = true;
let lastDisplayedData = null;
let dataAvailable = false;
let fetchCount = 0;

document.addEventListener('DOMContentLoaded', function() {
  loadExpiryDates();
  // Disable diff mode by default - use full refresh only
  document.getElementById('diffMode').checked = false;
});

function loadExpiryDates() {
  fetch('{{ url_for("main.api_live_monitor_expiry_dates") }}')
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        const expirySelect = document.getElementById('expirySelect');
        expirySelect.innerHTML = '<option value="">Select Expiry</option>';
        data.expiry_dates.forEach(date => {
          const option = document.createElement('option');
          option.value = date;
          option.textContent = date;
          expirySelect.appendChild(option);
        });
        if (data.expiry_dates.length > 0) {
          expirySelect.value = data.expiry_dates[0];
        }
      }
    })
    .catch(error => console.error('Error loading expiry dates:', error));
}

function loadPredefinedSymbols() {
  document.getElementById('symbolsInput').value = PREDEFINED_SYMBOLS.join(', ');
  console.log(`Loaded ${PREDEFINED_SYMBOLS.length} predefined symbols`);
}

function startMonitoring() {
  const symbolsInput = document.getElementById('symbolsInput').value;
  const symbols = symbolsInput.split(',').map(s => s.trim().toUpperCase()).filter(s => s);
  const expiry = document.getElementById('expirySelect').value;
  const distance = parseInt(document.getElementById('distancePercentage').value);
  const refresh = parseInt(document.getElementById('refreshInterval').value);
  
  if (symbols.length === 0) {
    alert('Please enter symbols');
    return;
  }
  
  if (!expiry) {
    alert('Please select an expiry date');
    return;
  }
  
  // SIMPLIFIED: Reset state
  isMonitoring = false; // Will be set to true after successful start
  dataAvailable = false;
  lastDisplayedData = null;
  fetchCount = 0;
  
  fetch('{{ url_for("main.api_live_monitor_start") }}', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      symbols: symbols,
      expiry_date: expiry,
      distance_percentage: distance,
      refresh_interval: refresh
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.status === 'started') {
      isMonitoring = true;
      
      document.getElementById('startBtn').disabled = true;
      document.getElementById('stopBtn').disabled = false;
      document.getElementById('monitorStatus').textContent = 'Running';
      document.getElementById('monitorStatus').className = 'text-success';
      document.getElementById('symbolCount').textContent = symbols.length;
      
      showLoadingMessage(symbols.length);
      startInitialDataLoad();
      
      console.log('SIMPLIFIED: Monitoring started successfully');
    } else {
      alert('Failed to start monitoring: ' + (data.error || 'Unknown error'));
    }
  })
  .catch(error => {
    console.error('Error starting monitoring:', error);
    alert('Error: ' + error.message);
  });
}

function showLoadingMessage(symbolCount) {
  const container = document.getElementById('liveDataContainer');
  container.innerHTML = `
    <div class="text-center py-5" id="loadingState">
      <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">Loading...</span>
      </div>
      <h4 class="mt-3">Processing ${symbolCount} symbols...</h4>
      <p class="text-muted">Initial data fetch may take 60-90 seconds. Please wait...</p>
      <div class="progress mt-3" style="height: 25px; max-width: 500px; margin: 0 auto;">
        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" 
             style="width: 0%" id="loadingProgress">0%</div>
      </div>
      <div class="mt-2">
        <small class="text-muted" id="loadingStatus">Checking for data...</small>
      </div>
    </div>
  `;
}

function stopMonitoring() {
  fetch('{{ url_for("main.api_live_monitor_stop") }}', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' }
  })
  .then(response => response.json())
  .then(data => {
    isMonitoring = false;
    dataAvailable = false;
    
    // Clear intervals
    if (updateInterval) {
      clearInterval(updateInterval);
      updateInterval = null;
    }
    if (initialLoadInterval) {
      clearInterval(initialLoadInterval);
      initialLoadInterval = null;
    }
    
    document.getElementById('startBtn').disabled = false;
    document.getElementById('stopBtn').disabled = true;
    document.getElementById('monitorStatus').textContent = 'Stopped';
    document.getElementById('monitorStatus').className = 'text-danger';
    
    console.log('SIMPLIFIED: Monitoring stopped');
  })
  .catch(error => console.error('Error stopping monitoring:', error));
}

function startInitialDataLoad() {
  let attempts = 0;
  const maxAttempts = 30;
  
  initialLoadInterval = setInterval(() => {
    if (!isMonitoring) {
      clearInterval(initialLoadInterval);
      return;
    }
    
    attempts++;
    
    // Update UI
    const progress = Math.min((attempts / maxAttempts) * 100, 95);
    const progressBar = document.getElementById('loadingProgress');
    const statusDiv = document.getElementById('loadingStatus');
    
    if (progressBar) {
      progressBar.style.width = progress + '%';
      progressBar.textContent = Math.round(progress) + '%';
    }
    if (statusDiv) {
      statusDiv.textContent = `Attempt ${attempts}/${maxAttempts} - Checking for data...`;
    }
    
    console.log(`SIMPLIFIED: Checking for data - attempt ${attempts}/${maxAttempts}`);
    
    checkForData()
      .then(hasData => {
        if (hasData) {
          console.log('SIMPLIFIED: Data found! Setting up regular updates');
          
          // Stop initial loading
          if (initialLoadInterval) {
            clearInterval(initialLoadInterval);
            initialLoadInterval = null;
          }
          
          // Load and display data
          refreshData();
          
          // Start regular update cycle
          startRegularUpdates();
        } else if (attempts >= maxAttempts) {
          // Max attempts reached
          if (initialLoadInterval) {
            clearInterval(initialLoadInterval);
            initialLoadInterval = null;
          }
          
          showWaitingMessage();
          startRegularUpdates(); // Still start updates for future data
        }
      })
      .catch(error => {
        console.error('Error checking for data:', error);
        if (attempts >= maxAttempts) {
          if (initialLoadInterval) {
            clearInterval(initialLoadInterval);
            initialLoadInterval = null;
          }
          startRegularUpdates();
        }
      });
  }, 4000);
}

function checkForData() {
  return fetch('{{ url_for("main.api_live_monitor_data") }}')
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success' && data.data && data.data.filtered_data) {
        const filteredData = data.data.filtered_data;
        
        const hasFiltered = filteredData.filtered && Array.isArray(filteredData.filtered) && filteredData.filtered.length > 0;
        const hasHighYield = filteredData.high_yield && Array.isArray(filteredData.high_yield) && filteredData.high_yield.length > 0;
        
        if (hasFiltered || hasHighYield) {
          dataAvailable = true;
          return true;
        }
      }
      return false;
    });
}

function showWaitingMessage() {
  const container = document.getElementById('liveDataContainer');
  container.innerHTML = `
    <div class="alert alert-warning">
      <h5><i class="bi bi-clock"></i> Waiting for data...</h5>
      <p>The monitoring system is running but no contracts match the filter criteria yet:</p>
      <ul>
        <li><strong>Filtered:</strong> Yield > 50,000 AND Distance% > 15%</li>
        <li><strong>High Yield:</strong> Yield > 80,000</li>
      </ul>
      <p>The system will automatically refresh when data becomes available.</p>
      <p><small class="text-muted">You can also manually refresh or adjust your filter criteria.</small></p>
      <button class="btn btn-primary" onclick="refreshData()">
        <i class="bi bi-arrow-clockwise"></i> Check Now
      </button>
    </div>
  `;
}

function startRegularUpdates() {
  const refreshRate = parseInt(document.getElementById('refreshInterval').value) * 1000;
  
  updateInterval = setInterval(() => {
    if (isMonitoring) {
      fetchCount++;
      console.log(`SIMPLIFIED: Regular update cycle ${fetchCount}`);
      
      if (dataAvailable || autoRefresh) {
        refreshData();
      } else {
        checkForData().then(hasData => {
          if (hasData && autoRefresh) {
            console.log('SIMPLIFIED: New data available, auto-refreshing');
            refreshData();
          }
        });
      }
    }
  }, refreshRate);
}

function refreshData() {
  console.log('SIMPLIFIED: Refreshing data...');
  
  fetch('{{ url_for("main.api_live_monitor_data") }}')
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success' && data.data) {
        console.log('SIMPLIFIED: Data refresh successful');
        
        // Always display the latest data
        displayData(data.data);
        updateStatusBar(data);
        dataAvailable = true;
        lastDisplayedData = data.data;
        
        // Play notification sound for new data
        if (soundNotifications && fetchCount > 1) {
          playNotificationSound();
        }
      } else {
        console.log('SIMPLIFIED: No valid data received');
        if (!dataAvailable) {
          showWaitingMessage();
        }
      }
    })
    .catch(error => {
      console.error('SIMPLIFIED: Error refreshing data:', error);
    });
}

function displayData(data) {
  console.log('SIMPLIFIED: Displaying data');
  const container = document.getElementById('liveDataContainer');
  
  // SIMPLIFIED: Always rebuild the entire display
  container.innerHTML = '';
  
  const filteredData = data.filtered_data;
  
  if (!filteredData) {
    container.innerHTML = '<div class="alert alert-warning">No filtered data available</div>';
    return;
  }
  
  let hasData = false;
  
  // Display Filtered Table
  if (showFiltered && filteredData.filtered && Array.isArray(filteredData.filtered) && filteredData.filtered.length > 0) {
    console.log(`SIMPLIFIED: Creating filtered table with ${filteredData.filtered.length} rows`);
    
    const sortedFiltered = [...filteredData.filtered].sort((a, b) => {
      return parseFloat(b['Dist %']) - parseFloat(a['Dist %']);
    });
    
    const filteredTable = createTable('Filtered Contracts', sortedFiltered, 'filtered', 'bg-warning');
    container.appendChild(filteredTable);
    hasData = true;
  }
  
  // Display High Yield Table
  if (showHighYield && filteredData.high_yield && Array.isArray(filteredData.high_yield) && filteredData.high_yield.length > 0) {
    console.log(`SIMPLIFIED: Creating high yield table with ${filteredData.high_yield.length} rows`);
    
    const sortedHighYield = [...filteredData.high_yield].sort((a, b) => {
      return parseFloat(b.Yield) - parseFloat(a.Yield);
    });
    
    const highYieldTable = createTable('High Yield Contracts', sortedHighYield, 'high_yield', 'bg-success');
    container.appendChild(highYieldTable);
    hasData = true;
  }
  
  if (!hasData) {
    showWaitingMessage();
  } else {
    updateCounts(filteredData);
  }
  
  console.log('SIMPLIFIED: Data display completed');
}

function createTable(title, rows, type, bgClass) {
  const card = document.createElement('div');
  card.className = 'card mb-3';
  card.id = `table-${type}`;
  
  card.innerHTML = `
    <div class="card-header ${bgClass} text-white">
      <h5 class="mb-0"><i class="bi bi-table"></i> ${title} <span class="badge bg-light text-dark">${rows.length}</span></h5>
      <small>Last updated: ${new Date().toLocaleTimeString()}</small>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
        <table class="table table-striped table-hover mb-0">
          <thead class="table-dark sticky-top">
            <tr>
              <th>Symbol</th>
              <th>CMP</th>
              <th>Type</th>
              <th>Strike</th>
              <th>Bid</th>
              <th>Days</th>
              <th>Prem/Day</th>
              <th>Prem Total</th>
              <th>Yield</th>
              <th>Dist %</th>
            </tr>
          </thead>
          <tbody>
            ${rows.map(row => createTableRow(row, type)).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;
  
  return card;
}

function createTableRow(row, type) {
  if (!row || typeof row !== 'object') {
    return '';
  }
  
  // Safe value extraction
  const symbol = String(row.Symbol || '');
  const cmp = parseFloat(row.CMP) || 0;
  const optionType = String(row.OptionType || '');
  const strikePrice = parseFloat(row.StrikePrice) || 0;
  const bidPrice = parseFloat(row.BidPrice) || 0;
  const daysLeft = parseInt(row['Days Left']) || 0;
  const premDay = parseFloat(row['Prem/Day']) || 0;
  const premTotal = parseFloat(row['Prem Until Expiry']) || 0;
  const yield_val = parseFloat(row.Yield) || 0;
  const distPct = parseFloat(row['Dist %']) || 0;
  
  // Highlighting
  let rowClass = '';
  if (highlightChanges) {
    if (type === 'filtered') {
      if (distPct >= 25) rowClass = 'table-danger';
      else if (distPct >= 20) rowClass = 'table-info';
      else if (distPct >= 18) rowClass = 'table-success';
      else if (distPct >= 15) rowClass = 'table-warning';
    } else if (type === 'high_yield') {
      if (yield_val >= 150000) rowClass = 'table-info';
      else if (yield_val >= 100000) rowClass = 'table-success';
      else if (yield_val >= 80000) rowClass = 'table-warning';
    }
  }
  
  const optionTypeClass = optionType === 'CE' ? 'success' : 'danger';
  
  return `
    <tr class="${rowClass}">
      <td><strong>${symbol}</strong></td>
      <td>₹${formatNumber(cmp)}</td>
      <td><span class="badge bg-${optionTypeClass}">${optionType}</span></td>
      <td>₹${formatNumber(strikePrice)}</td>
      <td>₹${formatNumber(bidPrice)}</td>
      <td>${daysLeft}</td>
      <td>₹${formatNumber(premDay)}</td>
      <td>₹${formatNumber(premTotal)}</td>
      <td class="fw-bold">₹${formatNumber(yield_val)}</td>
      <td><strong>${formatNumber(distPct)}%</strong></td>
    </tr>
  `;
}

function updateCounts(filteredData) {
  const filteredCount = (filteredData.filtered && Array.isArray(filteredData.filtered)) ? filteredData.filtered.length : 0;
  const highYieldCount = (filteredData.high_yield && Array.isArray(filteredData.high_yield)) ? filteredData.high_yield.length : 0;
  
  document.getElementById('filteredCount').textContent = filteredCount;
  document.getElementById('highYieldCount').textContent = highYieldCount;
}

function updateStatusBar(data) {
  document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
  if (data.data && data.data.stats) {
    const fetchTime = data.data.stats.last_fetch_time;
    document.getElementById('fetchTime').textContent = fetchTime ? `${fetchTime.toFixed(1)}s` : '-';
  }
}

function formatNumber(value) {
  if (value === null || value === undefined || isNaN(value)) return '0.00';
  return parseFloat(value).toFixed(2);
}

function playNotificationSound() {
  try {
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    oscillator.frequency.value = 800;
    oscillator.type = 'sine';
    
    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
    
    oscillator.start(audioContext.currentTime);
    oscillator.stop(audioContext.currentTime + 0.5);
  } catch (error) {
    console.log('Sound notification failed:', error);
  }
}

function showSettings() {
  const modal = new bootstrap.Modal(document.getElementById('settingsModal'));
  modal.show();
}

function applySettings() {
  showFiltered = document.getElementById('showFiltered').checked;
  showHighYield = document.getElementById('showHighYield').checked;
  highlightChanges = document.getElementById('highlightChanges').checked;
  soundNotifications = document.getElementById('soundNotifications').checked;
  autoRefresh = document.getElementById('autoRefresh').checked;
  
  // Refresh display if monitoring
  if (isMonitoring && lastDisplayedData) {
    displayData(lastDisplayedData);
  }
}

window.addEventListener('beforeunload', function() {
  if (isMonitoring) stopMonitoring();
});
</script>

<style>
.table-responsive {
  max-height: 600px;
  overflow-y: auto;
}

.sticky-top {
  position: sticky;
  top: 0;
  z-index: 10;
}

tr {
  transition: background-color 0.3s ease;
}

.table-striped > tbody > tr:nth-of-type(odd) > td {
  --bs-table-bg-type: rgba(0, 0, 0, 0.05);
}

/* Improved visual hierarchy */
.card-header small {
  opacity: 0.9;
  font-size: 0.85em;
}

.table-dark th {
  border-color: rgba(255, 255, 255, 0.2);
}

/* Better color coding */
.table-danger td {
  background-color: rgba(220, 53, 69, 0.1) !important;
}

.table-info td {
  background-color: rgba(13, 202, 240, 0.1) !important;
}

.table-success td {
  background-color: rgba(25, 135, 84, 0.1) !important;
}

.table-warning td {
  background-color: rgba(255, 193, 7, 0.1) !important;
}
</style>

{% endblock %}